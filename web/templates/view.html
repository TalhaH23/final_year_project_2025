{% extends "layout.html" %}

{% block title %}View PDF{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Left Column: Chat -->
    <div class="col-md-3 border-end d-flex flex-column" style="height: 100vh; overflow-y: auto; padding: 20px;">
        <h4>Chat Bot</h4>
        <form id="chat-form" class="mt-3">
            <div class="mb-2">
                <textarea id="chat-input" class="form-control" rows="3" placeholder="Type your message..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
        <div id="chat-box" class="mt-3" style="white-space: pre-wrap;"></div>
    </div>

    <!-- Middle Column: PDF -->
    <div class="col-md-5 d-flex flex-column" style="height: 100vh; overflow-y: auto; padding: 20px;">
        <h4>PDF Viewer</h4>
        <iframe src="{{ request.url_for('uploads', path=filename) }}" width="100%" height="100%"
            style="border: none;"></iframe>
        <!-- <p class="mt-2"><strong>Original File:</strong> {{ display_name or filename }}</p> -->
    </div>

    <!-- Right Column: Summary -->
    <div class="col border-start d-flex flex-column"
        style="height: 100vh; overflow-y: auto; padding: 20px; scroll-behavior: smooth;">
        <h4>Summary</h4>
        <div class="summary-content">
            {{ summary_text | safe }}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const conversationId = {{ conversation_id | tojson }};
    console.log("Using conversation ID:", conversationId);

    const chatBox = document.getElementById("chat-box");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userInput = input.value.trim();
        if (!userInput) return;

        chatBox.innerHTML += `üßë You: ${userInput}\n`;
        input.value = "";

        try {
            const response = await fetch(`/api/conversations/${conversationId}/messages`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ input: userInput })
            });

            const result = await response.json();
            chatBox.innerHTML += `ü§ñ AI: ${result.content}\n\n`;
        } catch (err) {
            console.error("Fetch error:", err);
            chatBox.innerHTML += `‚ö†Ô∏è Error sending message.\n\n`;
        }
    });
});
</script>
{% endblock %}
